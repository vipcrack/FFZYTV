#!/usr/bin/env python3
# generate_ffzytv_project.py (FINAL SAFE VERSION)
# å®Œæ•´ç”Ÿæˆå¯ç›´æ¥ ./gradlew æ„å»ºçš„ Android TV é¡¹ç›®

import os
import urllib.request
from pathlib import Path

PROJECT_NAME = "FFZYTV"
PACKAGE_NAME = "com.ffzy.tv"
APP_DIR = Path(PROJECT_NAME)
SRC_DIR = APP_DIR / "app" / "src" / "main"
JAVA_SRC = SRC_DIR / "java" / "com" / "ffzy" / "tv"

GRADLE_VERSION = "8.7"
GRADLE_WRAPPER_JAR_URL = f"https://downloads.gradle.org/distributions/gradle-{GRADLE_VERSION}-bin.zip"
# ä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯ wrapper jarï¼Œå¯ä» GitHub è·å–ï¼ˆæ›´å¯é ï¼‰
WRAPPER_JAR_URL = f"https://repo.gradle.org/gradle/dist-snapshots-repo/org/gradle/wrapper/{GRADLE_VERSION}/wrapper-{GRADLE_VERSION}.jar"

def write_file(path: Path, content: str):
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content.strip() + "\n")
    print(f"âœ… {path}")

def download_file(url: str, dest: Path):
    print(f"ğŸ“¥ ä¸‹è½½ {url} â†’ {dest}")
    try:
        urllib.request.urlretrieve(url, dest)
        print(f"âœ… å·²ä¸‹è½½: {dest.name}")
    except Exception as e:
        print(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
        # å›é€€åˆ° GitHub rawï¼ˆå¤‡ç”¨æºï¼‰
        fallback_url = f"https://raw.githubusercontent.com/gradle/gradle/v{GRADLE_VERSION}/subprojects/docs/src/docs/userguide/images/gradle-icon.png"  # å ä½
        # å®é™…ä¸Šï¼Œæœ€å¯é æ–¹å¼æ˜¯ä»å®˜æ–¹ ZIP æå–ï¼Œä½†å¤æ‚ï¼›è¿™é‡Œç”¨æ ‡å‡† CDN
        # æ”¹ç”¨ï¼šç›´æ¥ä½¿ç”¨ gradle.org çš„ wrapper jar é•œåƒ
        alt_url = f"https://services.gradle.org/distributions/gradle-{GRADLE_VERSION}-bin.zip"
        print("ğŸ’¡ æç¤ºï¼šè‡ªåŠ¨ä¸‹è½½ wrapper jar å¯èƒ½å—é™ï¼Œå»ºè®®åœ¨ CI ä¸­è¿è¡Œ 'gradle wrapper' ç”Ÿæˆ")
        raise

def create_project_structure():
    folders = [
        SRC_DIR / "res" / "layout",
        SRC_DIR / "res" / "values",
        SRC_DIR / "res" / "mipmap-mdpi",
        JAVA_SRC,
        APP_DIR / "gradle" / "wrapper",
    ]
    for folder in folders:
        folder.mkdir(parents=True, exist_ok=True)

def generate_gradle_wrapper():
    """ç”Ÿæˆå®Œæ•´çš„ Gradle Wrapperï¼šproperties + jar + gradlew è„šæœ¬"""
    wrapper_dir = APP_DIR / "gradle" / "wrapper"

    # 1. gradle-wrapper.properties
    props = f'''distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\\://services.gradle.org/distributions/gradle-{GRADLE_VERSION}-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
'''
    write_file(wrapper_dir / "gradle-wrapper.properties", props)

    # 2. gradle-wrapper.jar â€”â€” ä»å®˜æ–¹ä»“åº“ä¸‹è½½
    jar_path = wrapper_dir / "gradle-wrapper.jar"
    if not jar_path.exists():
        # ä½¿ç”¨å®˜æ–¹å‘å¸ƒçš„ wrapper jarï¼ˆé€šè¿‡ Gradle æ’ä»¶å‘å¸ƒï¼‰
        # å®é™…ä¸Šï¼Œæœ€ç®€å•æ–¹å¼ï¼šä» GitHub è·å–ï¼ˆv8.7 æ ‡ç­¾ä¸‹çš„æ–‡ä»¶ï¼‰
        jar_url = f"https://raw.githubusercontent.com/gradle/gradle/v{GRADLE_VERSION}/gradle/wrapper/gradle-wrapper.jar"
        print(f"ğŸ“¥ æ­£åœ¨ä¸‹è½½ gradle-wrapper.jar (v{GRADLE_VERSION})...")
        try:
            urllib.request.urlretrieve(jar_url, jar_path)
            print("âœ… gradle-wrapper.jar ä¸‹è½½æˆåŠŸ")
        except Exception as e:
            print(f"âš ï¸ æ— æ³•ä¸‹è½½ gradle-wrapper.jar: {e}")
            print("ğŸ’¡ å»ºè®®ï¼šè¿›å…¥é¡¹ç›®åè¿è¡Œ 'gradle wrapper --gradle-version {GRADLE_VERSION}' ç”Ÿæˆ")
            # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸åç»­æ‰‹åŠ¨ä¿®å¤
    else:
        print("âœ… gradle-wrapper.jar å·²å­˜åœ¨")

    # 3. gradlew è„šæœ¬ï¼ˆLinux/macOSï¼‰
    gradlew_content = '''#!/bin/bash

##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle 8.7
#
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \\(.*\\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn () {
    echo "$*"
}

die () {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
  NONSTOP* )
    nonstop=true
    ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar


# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
    case $MAX_FD in
      max*)
        # In POSIX sh, ulimit -H is undefined. That's why we use -S here.
        MAX_FD=`ulimit -H -n`
        if [ $? -eq 0 ] ; then
            ulimit -n "$MAX_FD"
        fi
        ;;
      *)
        ulimit -n "$MAX_FD" || true
        ;;
    esac
fi

# Collect all arguments for the java command, stacking in reverse order:
#   * args from the command line
#   * the main class name
#   * -classpath
#   * DEFAULT_JVM_OPTS
set -- \
        "$@" \
        org.gradle.wrapper.GradleWrapperMain \
        -classpath "$CLASSPATH" \
        $DEFAULT_JVM_OPTS

exec "$JAVACMD" "$@"
'''
    write_file(APP_DIR / "gradlew", gradlew_content)
    os.chmod(APP_DIR / "gradlew", 0o755)

    # 4. gradlew.batï¼ˆWindowsï¼Œå¯é€‰ï¼‰
    gradlew_bat = '''@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem

@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto execute

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\\gradle\\wrapper\\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega
'''
    write_file(APP_DIR / "gradlew.bat", gradlew_bat)

# å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼ˆbuild.gradleã€manifest ç­‰ï¼‰
def generate_project_build_gradle():
    content = '''plugins {
    id 'com.android.application' version '8.5.0' apply false
    id 'org.jetbrains.kotlin.android' version '1.9.20' apply false
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
'''
    write_file(APP_DIR / "build.gradle", content)

def generate_settings_gradle():
    content = '''pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = 'FFZYTV'
include ':app'
'''
    write_file(APP_DIR / "settings.gradle", content)

def generate_gradle_properties():
    content = '''org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
android.useAndroidX=true
android.enableJetifier=true
kotlin.code.style=official
'''
    write_file(APP_DIR / "gradle.properties", content)

def generate_app_build_gradle():
    content = '''plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace 'com.ffzy.tv'
    compileSdk 34

    defaultConfig {
        applicationId "com.ffzy.tv"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        debug {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = '17'
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.13.1'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.2.0'
    implementation 'androidx.leanback:leanback:1.1.0'

    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
}
'''
    write_file(APP_DIR / "app" / "build.gradle", content)

def generate_manifest():
    content = '''<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-feature
        android:name="android.software.leanback"
        android:required="true" />
    <uses-feature
        android:name="android.hardware.touchscreen"
        android:required="false" />

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:supportsRtl="true"
        android:theme="@style/Theme.Leanback"
        tools:targetApi="34">
        
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LEANBACK_LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
'''
    write_file(SRC_DIR / "AndroidManifest.xml", content)

def generate_main_activity():
    content = '''package com.ffzy.tv

import android.os.Bundle
import androidx.fragment.app.FragmentActivity

class MainActivity : FragmentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }
}
'''
    write_file(JAVA_SRC / "MainActivity.kt", content)

def generate_layout():
    content = '''<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@android:color/black">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_gravity="center"
        android:text="FFZYTV"
        android:textColor="@android:color/white"
        android:textSize="32sp" />

</FrameLayout>
'''
    write_file(SRC_DIR / "res" / "layout" / "activity_main.xml", content)

def generate_strings():
    content = '''<resources>
    <string name="app_name">FFZYTV</string>
</resources>
'''
    write_file(SRC_DIR / "res" / "values" / "strings.xml", content)

def generate_dummy_icon():
    icon = '''<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="48dp"
    android:height="48dp"
    android:viewportWidth="48"
    android:viewportHeight="48">
    <path
        android:fillColor="#FFFFFF"
        android:pathData="M12,36 L36,36 L36,12 L12,12 Z" />
</vector>
'''
    write_file(SRC_DIR / "res" / "mipmap-mdpi" / "ic_launcher.xml", icon)

def main():
    print(f"ğŸš€ æ­£åœ¨ç”Ÿæˆ FFZYTV Android TV é¡¹ç›® (Gradle {GRADLE_VERSION})...\n")
    
    create_project_structure()
    generate_project_build_gradle()
    generate_settings_gradle()
    generate_gradle_properties()
    generate_app_build_gradle()
    generate_manifest()
    generate_main_activity()
    generate_layout()
    generate_strings()
    generate_dummy_icon()
    generate_gradle_wrapper()  # âœ… åŒ…å« jar + gradlew

    print("\nğŸ‰ é¡¹ç›®ç”Ÿæˆå®Œæˆï¼å·²åŒ…å«å®Œæ•´çš„ Gradle Wrapperã€‚")
    print(f"\nğŸ“ é¡¹ç›®è·¯å¾„: ./{PROJECT_NAME}")
    print("\nğŸ”§ ç›´æ¥æ„å»ºï¼š")
    print(f"  cd {PROJECT_NAME}")
    print("  ./gradlew assembleDebug --no-daemon --stacktrace")
    print("\nğŸ“¦ APK è·¯å¾„: app/build/outputs/apk/debug/app-debug.apk")

if __name__ == "__main__":
    main()
